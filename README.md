# VESS: An R package for vaccine efficacy sample size calculations in a multiple vaccine and multiple pathogen variant scenario.

## 1. Problem
An important problem in vaccine efficacy (VE) studies is sample size calculation during study planning. Vaccine manufacturers may face two types of sample size challenges. First, to have enough subjects to show a non-zero VE or to show that VE is above a certain threshold (superiority trial). In this setting one can obtain an appropriate sample size utilizing the hypothesis testing framework. A second type of challenge is having enough subjects to obtain precise estimates of VE to further assist in decisions pertaining to the various phases of the development of a vaccine. In statistical terms, precision refers to confidence limits of the VE, and a narrower confidence interval can be obtained with a larger sample size. While the actual confidence limits depend upon the actual data, using Monte Carlo simulations confidence intervals can also be simulated and a range for both the upper and lower confidence limit can be obtained. Currently available tools such as the **R** package **epiR** (<https://cran.r-project.org/web/packages/epiR/index.html>) and general purpose calculators such as PASS (<https://www.ncss.com/software/pass/>) only handle the single variant and single vaccine scenario. Another drawback of the current tools is that for sample size calculations aiming at obtaining a certain precision (Kelley et al., 2003) for VE, the calculators provide precision assuming that the actual data will be equal to the expected cell counts of a 2 x 2 cross table of infection and vaccination status. Thus, they ignore the randomness of the data generating process. Besides, current calculators also do not support multiple variants and multiple vaccines.

The second problem VE studies face is that depending upon the vaccine's action mechanism (leaky versus all-or-none) the various estimands of VE, namely `VE = 1 - incidence rate ratio`, `VE = 1 - cumulative incidence ratio`, and `VE = 1 - odds ratio`, can be time-dependent even in absence of waning VE. Time-dependency in a single variant scenario has discussed by Smith et al. (1984). However, time-dependency of VE in multiple pathogen variant scenario has a different behavior. Knowing the time-varying behavior of VE estimands can help practitioners choose the right VE estimand and/or to interpret their VE results better.

## 2. Motivation and Funding 
The motivation for this work comes from two sources. First, from the requirements of IMI's DRIVE (<https://www.drive-eu.org/>) project that provided funding for this work. Here IMI stands for 'Innovative Medicines Initiative', and DRIVE is an abbreviation of 'Development of Robust and Innovative Vaccine Effectiveness'. The DRIVE project aims to set up a platform, bringing together all stakeholders, to study brand-specific and variant-specific influenza vaccine effectiveness in the European Union. Within DRIVE, both cohort and test-negative design (TND) studies are used. For these designs, in the context of DRIVE's multiple pathogen variant and multiple vaccine scenario, two challenges remain unresolved. First, that variant-specific vaccine efficacy (VE) estimands can be time-dependent. This may affect conclusions regarding the efficacy of a vaccine. Although, time-dependency of a VE estimand is not a drawback per se in other situations. For example, employing `VE = 1 - cumulative incidence ratio` is time-dependent in leaky vaccines, but it still provides the estimate of the 'effectiveness' (Hanquet et al., 2013) of a vaccine (different from vaccine efficacy VE). Thus, `VE = 1 - cumulative incidence ratio` is useful in making a decision for rolling out a vaccine and/or for assessing the population level benefit of a vaccine roll out. This brings us to the second challenge that for study planners there is currently no sample size calculator available that handles multiple variants and multiple vaccines. While the DRIVE project focuses on influenza, the multiple variant situation is also present in other pathogens such as dengue and human-immunodeficiency virus. Our second motivation comes from the current COVID-19 pandemic (World Health Organization, 2020). Recently, multiple studies that estimate variant-specific VE for COVID-19 vaccines have been published (Shinde et al., 2021; Abu-Raddad et al., 2021; Lopez et al., 2021; Madhi et al., 2021}. These studies mark the importance of evaluating if the various VE estimands remain time-invariant, and substantiate the need for a sample size calculator for the multiple variant and multiple vaccine scenario.

## 3. Functions Summary
While the detailed use of the R functions is available in the package documentation, here we give a brief summary of their internal working. This package has three R functions for finding the expected precision for a given vaccine efficacy and sample size. In each function 500 simulations are conducted by default. In each simulation we sample a `(I + 1) x (M + 1)` table of number of cases (extra one row for controls) that get infected by `I` pathogen variants after being vaccinated with one of the `M` vaccines (extra one column for placebo). We then calculate a point esimate of VE and obtain a confidence interval using normal approximation. The 500 confindence intervals from 500 simulations can be used to obtain an expected precision. Precision can de defined in terms of the expected width of the confidence intervals of the expected lower and upper limits.
* `get_cohort_expectedCI_VE_irr()`
* `get_cohort_expectedCI_VE_cir()`
* `get_cohort_expectedCI_VE_or()`

Then there are three R functions for finding the minimum detectable VE given a sample size, power, and Type-I error. These functions are wrappers over the functions `epi.sscohortt`, `epi.sscohortc` and `epi.sscc` functions of the **R** package **epiR**. The following three functions also require the anticipated VE of each vaccine against each variant as an input. In general, if the interest is in finding minimum detectable VE then asking for anticipated VE may seem paradoxical. However, we only use the anticipated VE while adjusting the sample sizes and the attack rates to account for multiple pathogen variants and multiple vaccines, before calling the functions of the **epiR** package. 

* `get_cohort_mindet_VE_irr()` for minimum detectable VE when the VE is estimated as VE = 1 - incidence rate ratio.
* `get_cohort_mindet_VE_cir()` for minimum detectable VE when the VE is estimated as VE = 1 - cumulative incidence ratio.
* `get_cohort_mindet_VE_or()` for minimum detectable VE when the VE is estimated as VE = 1 - odds ratio.

Lastly, there are two R functions for finding the time-dependency of three VE estimands namely `VE = 1 - incidence rate ratio`, `VE = 1 - cumulative incidence ratio`, and `VE = 1 - odds ratio`, for leaky and all-or-none action vaccines. The R functions not only provide time-dependency of absolute VE but also of relative VE for comparing vaccines or comparing VE of a single vaccine against multiple variants.
* `get_allornone_ve_estimands()`
* `get_leaky_ve_estimands()`

## 4. Computational Advantages
The simulations conducted in this package would normally take many minutes to run. However, to optimize them we used two tricks. First instead of using a three level nested for loop (sample size, vaccine and variant combination, and number of simulations) we used three dimensional arrays in **R**. Second, we sampled simulation data from probability distributions that have a fast native implementation in **R**. For example, we sampled the data for the `(I + 1) x (M + 1)` sized case/control table using a multinomial distribution. When the target estimand was `VE = 1 - incidence rate ratio`, a person-time estimate is required in the denominator of the incidence rate ratio. The naive method of simulating event-time of each subject using exponential distribution (**R** function **rexp**) and adding them up is very slow. A better idea is to sample the sum of the person-time of each subject directly. If the study period is `[0, t]` and event rate in the study period is `p` per unit time, then `exp(-pt)%` subjects will not obtain the event and contribute `t` units of time each. The remaining `exp(-pt)%` subjects will obtain the event and individually contribute an event time whose sum can be directly sampled from a normal distribution. This is because the sum of event times of `K` eventful subjects follows a normal distributon with mean equal to the `K x mean of a truncated exponential distribution in interval [0, t]` and variance equal to the variance of uniform distribution with interval length equal to `[0,t]`.

## References
Abu-Raddad, L. J., Chemaitelly, H., & Butt, A. A. (2021). Effectiveness of the BNT162b2 Covid-19 Vaccine against the B. 1.1. 7 and B. 1.351 Variants. New England Journal of Medicine.

Hanquet, G., Valenciano, M., Simondon, F., & Moren, A. (2013). Vaccine effects and impact of vaccination programmes in post-licensure studies. Vaccine, 31(48), 5634-5642.

Kelley, K., Maxwell, S. E., & Rausch, J. R. (2003). Obtaining power or obtaining precision: Delineating methods of sample-size planning. Evaluation & the health professions, 26(3), 258-287.

Lopez Bernal, J., Andrews, N., Gower, C., Gallagher, E., Simmons, R., Thelwall, S., Stowe, J., Tessier, E.,Groves, N., Dabrera, G., et al. (2021). Effectiveness of covid-19 vaccines against the b. 1.617. 2 (delta)variant.New England Journal of Medicine.

Madhi, S. A., Baillie, V., Cutland, C. L., Voysey, M., Koen, A. L., Fairlie, L., Padayachee, S. D., Dheda, K.,Barnabas, S. L., Bhorat, Q. E., et al. (2021). Efficacy of the chadox1 ncov-19 covid-19 vaccine againstthe b. 1.351 variant.New England Journal of Medicine, 384(20):1885–1898.

Shinde, V., Bhikha, S., Hoosain, Z., Archary, M., Bhorat, Q., Fairlie, L., Lalloo, U., Masilela, M. S.,Moodley, D., Hanley, S., et al. (2021). Efficacy of nvx-cov2373 covid-19 vaccine against the b. 1.351variant.New England Journal of Medicine, 384(20):1899–1909.

Smith, P. G., Rodrigues, L. C., & Fine, P. E. M. (1984). Assessment of the protective efficacy of vaccines against common diseases using case-control and cohort studies. International journal of epidemiology, 13(1), 87-93.

World Health Organization (2020). Coronavirus disease 2019 (covid-19): situation report, 73. page 13 p.
